name: Build Raspberry Pi BBRv3 Kernel

on:
  workflow_dispatch: # Manual trigger
  schedule:
    - cron: "0 2 * * 0" # Check weekly on Sunday at 2:00 UTC

jobs:
  check-updates:
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}
      rpi_commit: ${{ steps.check.outputs.rpi_commit }}
      bbr_commit: ${{ steps.check.outputs.bbr_commit }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Check for Upstream Updates
        id: check
        run: |
          # Get latest commit from Raspberry Pi kernel
          RPI_COMMIT=$(git ls-remote https://github.com/raspberrypi/linux.git refs/heads/rpi-6.13.y | cut -f1)
          echo "Raspberry Pi kernel latest commit: $RPI_COMMIT"

          # Get latest commit from Google BBR v3
          BBR_COMMIT=$(git ls-remote https://github.com/google/bbr.git refs/heads/v3 | cut -f1)
          echo "Google BBR v3 latest commit: $BBR_COMMIT"

          # Read last built commits (if file exists)
          LAST_RPI=""
          LAST_BBR=""
          if [ -f .last_built_commits ]; then
            LAST_RPI=$(grep "^rpi=" .last_built_commits | cut -d= -f2 || echo "")
            LAST_BBR=$(grep "^bbr=" .last_built_commits | cut -d= -f2 || echo "")
          fi

          echo "Last built RPi commit: $LAST_RPI"
          echo "Last built BBR commit: $LAST_BBR"

          # Determine if we should build
          if [ "$RPI_COMMIT" != "$LAST_RPI" ] || [ "$BBR_COMMIT" != "$LAST_BBR" ]; then
            echo "Updates found! Triggering build..."
            echo "should_build=true" >> $GITHUB_OUTPUT
          else
            echo "No updates found. Skipping build."
            echo "should_build=false" >> $GITHUB_OUTPUT
          fi

          # For manual triggers, always build
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "Manual trigger detected. Forcing build..."
            echo "should_build=true" >> $GITHUB_OUTPUT
          fi

          echo "rpi_commit=$RPI_COMMIT" >> $GITHUB_OUTPUT
          echo "bbr_commit=$BBR_COMMIT" >> $GITHUB_OUTPUT

  build:
    needs: check-updates
    if: needs.check-updates.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write # Required for creating releases and updating commit file

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Cross-Compilation Dependencies
        run: |
          sudo apt-get update
          # Install native build tools and cross-compiler
          # Note: We don't need arm64 libs - the kernel build uses CROSS_COMPILE for linking
          sudo apt-get install -y \
            git build-essential bison flex libssl-dev libelf-dev bc \
            rsync kmod cpio dwarves debhelper dh-make fakeroot \
            gcc-aarch64-linux-gnu g++-aarch64-linux-gnu \
            binutils-aarch64-linux-gnu
          echo "Debhelper version: $(dpkg -s debhelper | grep Version)"
          echo "Cross-compiler version: $(aarch64-linux-gnu-gcc --version | head -1)"

      - name: Clone Raspberry Pi Kernel (rpi-6.13.y)
        run: |
          # Clone shallowly to save time
          git clone -b rpi-6.13.y --depth 1 https://github.com/raspberrypi/linux.git linux-src

      - name: Merge Google BBRv3
        working-directory: ./linux-src
        run: |
          git remote add google-bbr https://github.com/google/bbr.git
          git fetch google-bbr v3

          git config user.email "action@github.com"
          git config user.name "GitHub Action"

          # Merge BBRv3, preferring BBR's changes for conflicts (mostly networking/TCP files)
          # We use a custom merge strategy or just "theirs" for simplicity if conflicts arise in net/ipv4
          if git merge --allow-unrelated-histories --no-edit google-bbr/v3; then
               echo "Merge successful"
          else
               echo "Merge conflict detected. Attempting to resolve by accepting incoming changes..."
               # In a real pipeline, we might want to be more careful, but for BBR integration:
               git merge --abort
               git merge --strategy-option=theirs --allow-unrelated-histories --no-edit google-bbr/v3
          fi

          # Extract version for naming
          KERNEL_VER=$(make kernelversion)
          echo "KERNEL_VER=$KERNEL_VER" >> $GITHUB_ENV
          echo "Detected base kernel version: $KERNEL_VER"

      - name: Configure Kernel
        working-directory: ./linux-src
        run: |
          # Use user provided config if available, otherwise default Pi 4 config
          if [ -f ../pi.config ]; then
            echo "Using provided pi.config..."
            cp ../pi.config .config
          else
            echo "Using default bcm2711_defconfig..."
            export ARCH=arm64
            export CROSS_COMPILE=aarch64-linux-gnu-
            make bcm2711_defconfig
          fi

          # Verify ARCH is set correctly in config or env
          export ARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-

          # Enable BBRv3 config options
          ./scripts/config --enable CONFIG_TCP_CONG_ADVANCED
          ./scripts/config --enable CONFIG_NET_SCH_FQ
          ./scripts/config --enable CONFIG_TCP_CONG_BBR
          ./scripts/config --enable CONFIG_DEFAULT_BBR
          ./scripts/config --set-str CONFIG_DEFAULT_TCP_CONG "bbr"

          # Set Local Version
          sed -i 's/EXTRAVERSION =/EXTRAVERSION = -bbrv3-pi/' Makefile

          # Update config
          make olddefconfig

      - name: Build Kernel Packages
        working-directory: ./linux-src
        run: |
          export ARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-

          # Patch Makefile.package to skip dependency check (-d flag)
          # The kernel's bindeb-pkg doesn't support DPKGFLAGS, so we patch directly
          sed -i 's/dpkg-buildpackage /dpkg-buildpackage -d /' scripts/Makefile.package
          cat scripts/Makefile.package | grep dpkg-buildpackage  # Verify patch

          # Build using all cores
          make -j$(nproc) bindeb-pkg

      - name: Move Artifacts
        run: |
          mkdir artifacts
          mv linux-*.deb artifacts/

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: bbrv3-pi-kernel
          path: artifacts/*.deb

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ env.KERNEL_VER }}-bbrv3-${{ github.run_number }}
          name: Raspberry Pi BBRv3 Kernel ${{ env.KERNEL_VER }}
          body: |
            ## Raspberry Pi BBRv3 Kernel

            **Kernel Version:** ${{ env.KERNEL_VER }}

            ### Source Commits
            - Raspberry Pi Kernel: `${{ needs.check-updates.outputs.rpi_commit }}`
            - Google BBR v3: `${{ needs.check-updates.outputs.bbr_commit }}`

            ### Installation
            ```bash
            # Download and install
            sudo dpkg -i linux-image-*.deb
            sudo reboot

            # Verify
            uname -r
            sysctl net.ipv4.tcp_congestion_control
            ```
          draft: false
          prerelease: false
          files: artifacts/*.deb

      - name: Update Last Built Commits
        run: |
          echo "rpi=${{ needs.check-updates.outputs.rpi_commit }}" > .last_built_commits
          echo "bbr=${{ needs.check-updates.outputs.bbr_commit }}" >> .last_built_commits

          git config user.email "action@github.com"
          git config user.name "GitHub Action"
          git add .last_built_commits
          git commit -m "Update last built commits [skip ci]" || echo "No changes to commit"
          git push || echo "Push failed - may need to pull first"
